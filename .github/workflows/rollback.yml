# ============================================================================
# Manual Rollback Workflow
# ============================================================================
# Use this to quickly rollback to a previous deployment
# ============================================================================

name: Rollback Production

on:
  workflow_dispatch:
    inputs:
      rollback_target:
        description: 'Rollback target (previous, or specific sha like sha-abc1234)'
        required: true
        default: 'previous'
      reason:
        description: 'Reason for rollback'
        required: true
        default: 'Production issue'

env:
  VPS_HOST: 66.116.225.67
  VPS_USER: deploy
  DEPLOY_PATH: /opt/clinomic
  BACKEND_IMAGE: ghcr.io/dev-abiox/production-ready/backend
  FRONTEND_IMAGE: ghcr.io/dev-abiox/production-ready/frontend

jobs:
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Validate inputs
        run: |
          echo "Rollback Target: ${{ github.event.inputs.rollback_target }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Initiated by: ${{ github.actor }}"
          echo "Timestamp: $(date -Iseconds)"

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts
          
          cat > ~/.ssh/config << EOF
          Host production
            HostName ${{ env.VPS_HOST }}
            User ${{ env.VPS_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking accept-new
            HostKeyAlgorithms +ssh-rsa
            PubkeyAcceptedAlgorithms +ssh-rsa
          EOF
          chmod 600 ~/.ssh/config

      - name: Execute Rollback
        run: |
          ssh production << 'ROLLBACK_SCRIPT'
            set -e
            
            ROLLBACK_TARGET="${{ github.event.inputs.rollback_target }}"
            REASON="${{ github.event.inputs.reason }}"
            ACTOR="${{ github.actor }}"
            
            echo "=========================================="
            echo "CLINOMIC PRODUCTION ROLLBACK"
            echo "=========================================="
            echo "Target: $ROLLBACK_TARGET"
            echo "Reason: $REASON"
            echo "Initiated by: $ACTOR"
            echo "Timestamp: $(date -Iseconds)"
            echo ""
            
            cd ${{ env.DEPLOY_PATH }}
            
            if [ "$ROLLBACK_TARGET" == "previous" ]; then
              echo "Rolling back to previous deployment..."
              
              if [ -f .last_deploy_images ]; then
                echo "Found previous images:"
                cat .last_deploy_images
                
                # Restore previous images
                while IFS= read -r image; do
                  echo "Restoring: $image"
                  SERVICE=$(echo $image | grep -o 'backend\|frontend')
                  docker tag "$image" "clinomic-$SERVICE:latest" || true
                done < .last_deploy_images
              else
                echo "ERROR: No previous deployment record found!"
                exit 1
              fi
              
            else
              # Specific version rollback
              echo "Rolling back to specific tag: $ROLLBACK_TARGET"
              
              TAG="$ROLLBACK_TARGET"
              
              echo "Pulling specific versions..."
              docker pull ${{ env.BACKEND_IMAGE }}:$TAG
              docker pull ${{ env.FRONTEND_IMAGE }}:$TAG
              
              docker tag ${{ env.BACKEND_IMAGE }}:$TAG clinomic-backend:latest
              docker tag ${{ env.FRONTEND_IMAGE }}:$TAG clinomic-frontend:latest
            fi
            
            echo ""
            echo "Restarting services..."
            sudo docker-compose -f docker-compose.prod.yml up -d --force-recreate backend frontend
            
            echo ""
            echo "Waiting for health check..."
            for i in {1..30}; do
              if curl -sf http://localhost:8001/api/health/ready > /dev/null 2>&1; then
                echo "âœ“ Health check passed after $i seconds"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âœ— Health check failed after 30 seconds"
                exit 1
              fi
              sleep 1
            done
            
            # Reload nginx
            docker exec nginx nginx -s reload 2>/dev/null || sudo nginx -s reload 2>/dev/null || true
            
            # Log rollback
            echo "$(date -Iseconds) | ROLLBACK | $ROLLBACK_TARGET | $REASON | $ACTOR" >> /var/log/clinomic-deploys.log
            
            echo ""
            echo "=========================================="
            echo "ROLLBACK COMPLETE"
            echo "=========================================="
          ROLLBACK_SCRIPT

      - name: Verify rollback
        run: |
          echo "Verifying rollback..."
          sleep 5
          
          curl -sf "https://clinomiclabs.com/api/health/ready" | jq . || echo "Verification failed"
          
          echo ""
          echo "Rollback verification complete."

      - name: Create rollback record
        run: |
          echo "## ðŸ”„ Rollback Executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Target | ${{ github.event.inputs.rollback_target }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Reason | ${{ github.event.inputs.reason }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Initiated by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -Iseconds) |" >> $GITHUB_STEP_SUMMARY
