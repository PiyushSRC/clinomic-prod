name: Rollback Production

on:
  workflow_dispatch:
    inputs:
      rollback_target:
        description: "Tag to rollback to (e.g. sha-abc1234 or 'previous')"
        required: true
        default: "previous"

env:
  VPS_HOST: 66.116.225.67
  VPS_USER: deploy
  DEPLOY_PATH: /opt/clinomic
  BACKEND_IMAGE: ghcr.io/dev-abiox/production-ready/backend
  FRONTEND_IMAGE: ghcr.io/dev-abiox/production-ready/frontend

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Execute rollback
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_PRIVATE_KEY_PROD }}
          port: 22
          script: |
            set -e
            cd /opt/clinomic

            TAG="${{ github.event.inputs.rollback_target }}"

            if [ "$TAG" = "previous" ]; then
              echo "Using previous images..."
              docker compose -f docker-compose.v3.yml up -d
              exit 0
            fi

            echo "Rolling back to $TAG"

            docker pull ghcr.io/dev-abiox/production-ready/backend:$TAG
            docker pull ghcr.io/dev-abiox/production-ready/frontend:$TAG

            docker tag ghcr.io/dev-abiox/production-ready/backend:$TAG ghcr.io/dev-abiox/production-ready/backend:latest
            docker tag ghcr.io/dev-abiox/production-ready/frontend:$TAG ghcr.io/dev-abiox/production-ready/frontend:latest

            docker compose -f docker-compose.v3.yml up -d --force-recreate

      - name: Health Check
        run: |
          for i in {1..20}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" https://clinomiclabs.com/api/health/ready || true)
            if [ "$code" = "200" ]; then
              echo "Rollback healthy"
              exit 0
            fi
            sleep 5
          done
          exit 1
