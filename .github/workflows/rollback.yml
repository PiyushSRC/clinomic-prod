name: Rollback Production

on:
  workflow_dispatch:
    inputs:
      rollback_target:
        description: "Tag to rollback to (e.g. sha-abc1234 or 'previous')"
        required: true
        default: "previous"

env:
  VPS_HOST: 66.116.225.67
  VPS_USER: deploy
  DEPLOY_PATH: /opt/clinomic
  BACKEND_IMAGE: ghcr.io/dev-abiox/production-ready/backend
  FRONTEND_IMAGE: ghcr.io/dev-abiox/production-ready/frontend

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh

          cat > ~/.ssh/deploy_key << 'EOF'
          ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          EOF
          chmod 600 ~/.ssh/deploy_key

          ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Execute rollback
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'EOF'
            set -e
            cd /opt/clinomic

            TAG="${{ github.event.inputs.rollback_target }}"

            if [ "$TAG" = "previous" ]; then
              echo "Using previous images..."
              docker compose -f docker-compose.v3.yml up -d
              exit 0
            fi

            echo "Rolling back to $TAG"

            docker pull ghcr.io/dev-abiox/production-ready/backend:$TAG
            docker pull ghcr.io/dev-abiox/production-ready/frontend:$TAG

            docker tag ghcr.io/dev-abiox/production-ready/backend:$TAG ghcr.io/dev-abiox/production-ready/backend:latest
            docker tag ghcr.io/dev-abiox/production-ready/frontend:$TAG ghcr.io/dev-abiox/production-ready/frontend:latest

            docker compose -f docker-compose.v3.yml up -d --force-recreate
          EOF

      - name: Health Check
        run: |
          for i in {1..20}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" https://clinomiclabs.com/api/health/ready || true)
            if [ "$code" = "200" ]; then
              echo "Rollback healthy"
              exit 0
            fi
            sleep 5
          done
          exit 1
