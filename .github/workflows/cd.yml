name: Continuous Deployment

on:
    push:
        branches: ["main", "develop"]

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

# 4) Add Concurrency Control
concurrency:
    group: deploy-${{ github.ref }}
    cancel-in-progress: true

jobs:
    deploy:
        name: Build & Deploy
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - uses: actions/checkout@v4

            - name: Set Environment Variables
              run: |
                  if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
                    echo "ENV_NAME=prod" >> $GITHUB_ENV
                    echo "REACT_URL=https://api.clinomiclabs.com" >> $GITHUB_ENV
                    echo "SSH_HOST=${{ secrets.SSH_HOST_PROD }}" >> $GITHUB_ENV
                    echo "SSH_USER=${{ secrets.SSH_USER_PROD }}" >> $GITHUB_ENV
                    echo "SSH_KEY=${{ secrets.SSH_PRIVATE_KEY_PROD }}" >> $GITHUB_ENV
                  else
                    echo "ENV_NAME=staging" >> $GITHUB_ENV
                    echo "REACT_URL=https://api.testing.clinomiclabs.com" >> $GITHUB_ENV
                    echo "SSH_HOST=${{ secrets.SSH_HOST_STAGING }}" >> $GITHUB_ENV
                    echo "SSH_USER=${{ secrets.SSH_USER_STAGING }}" >> $GITHUB_ENV
                    echo "SSH_KEY=${{ secrets.SSH_PRIVATE_KEY_STAGING }}" >> $GITHUB_ENV
                  fi

            - name: Log in to the Container registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and Push Backend
              uses: docker/build-push-action@v5
              with:
                  context: ./backend_v3
                  push: true
                  tags: |
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:${{ github.sha }}
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:${{ env.ENV_NAME }}

            - name: Build and Push Frontend
              uses: docker/build-push-action@v5
              with:
                  context: ./frontend
                  build-args: |
                      REACT_APP_BACKEND_URL=${{ env.REACT_URL }}
                  push: true
                  tags: |
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${{ github.sha }}
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${{ env.ENV_NAME }}

            - name: Deploy via SSH
              # 1) Pin SSH Action Version (Important)
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ env.SSH_HOST }}
                  username: ${{ env.SSH_USER }}
                  key: ${{ env.SSH_KEY }}
                  envs: GHCR_PAT,REACT_URL
                  script: |
                      # Navigate to project
                      cd /opt/clinomic

                      # 3) GHCR Login on the VM (Critical)
                      # Note: Using GHCR_PAT secret is recommended for remote servers over GITHUB_TOKEN
                      # If GHCR_PAT is not set, this will fail if the repo is private.
                      # Assuming GHCR_PAT is available in secrets as per design.
                      echo "$GHCR_PAT" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

                      # Update code (for scripts)
                      git fetch origin ${{ github.ref_name }}
                      git checkout ${{ github.ref_name }}
                      git pull origin ${{ github.ref_name }}

                      # Ensure production compose file exists
                      cp docker-compose.v3.yml docker-compose.prod.yml

                      # 2) Tenant Migrations (Shared + Tenant)
                      # Using backend_v3 service name
                      echo "Running shared migrations..."
                      sudo docker compose -f docker-compose.prod.yml run --rm backend_v3 python manage.py migrate_schemas --shared

                      echo "Running tenant migrations..."
                      sudo docker compose -f docker-compose.prod.yml run --rm backend_v3 python manage.py migrate_schemas

                      # Run deployment script
                      # The script pulls images
                      # Ideally, we should export TAG here so deploy.sh picks it up if updated
                      export TAG=${{ github.sha }}
                      sudo -E ./scripts/deploy/deploy.sh --tag=${{ github.sha }} --force

                      # 5) Real Health Check
                      echo "Verifying deployment..."
                      curl -f "$REACT_URL/health" || exit 1
