name: Continuous Integration

on:
    push:
        branches: ["main", "develop", "feature/*"]
    pull_request:
        branches: ["main", "develop"]

jobs:
    backend-test:
        name: Backend Tests & Security
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./backend_v3

        services:
            postgres:
                image: postgres:15-alpine
                env:
                    POSTGRES_DB: clinomic_test
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: password
                ports:
                    - 5432:5432
                # Healthcheck is good, but we add an explicit wait step for reliability
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.12
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install flake8 bandit safety

            - name: Wait for Database
              # Explicit wait to prevent race conditions even with service healthcheck
              run: |
                  echo "Waiting for PostgreSQL to be ready..."
                  until pg_isready -h localhost -p 5432 -U postgres; do
                    echo "Postgres is unavailable - sleeping"
                    sleep 2
                  done
                  echo "Postgres is up!"

            - name: Run Bandit Security Scan
              # Scanning strictly for High severity issues
              run: bandit -r . --severity high --exit-zero

            - name: Run Dependency Vulnerability Scan (Safety)
              run: safety check

            - name: Lint with flake8
              run: |
                  # stop the build if there are Python syntax errors or undefined names
                  flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
                  # exit-zero treats all errors as warnings
                  flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

            - name: Run Tests
              env:
                  DJANGO_SECRET_KEY: "test-key-not-for-production"
                  POSTGRES_HOST: localhost
                  POSTGRES_PORT: 5432
                  POSTGRES_DB: clinomic_test
                  POSTGRES_USER: postgres
                  POSTGRES_PASSWORD: password
                  APP_ENV: test
              run: |
                  python manage.py test

    frontend-test:
        name: Frontend Tests & Build
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./frontend

        steps:
            - uses: actions/checkout@v4

            - name: Set up Node.js 20
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies (Strict)
              # npm ci provides a determinstic install based on package-lock.json
              # Using legacy-peer-deps as required by the project
              run: npm ci --legacy-peer-deps

            - name: Lint
              run: npm run lint

            - name: Run Unit Tests
              run: npm test -- --watchAll=false --passWithNoTests

            - name: Production Build Check
              # Removing CI=false ensures that warnings = errors (default CI behavior)
              # If build has bad practices/warnings, this will now fail.
              run: npm run build
              env:
                  REACT_APP_BACKEND_URL: "http://localhost:8000" # Dummy URL for build check
