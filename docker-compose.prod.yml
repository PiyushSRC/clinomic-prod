# ============================================================================
# CLINOMIC B12 SCREENING PLATFORM - PRODUCTION COMPOSE
# ============================================================================
# Domain: clinomiclabs.com
# VPS: 66.116.225.67
# Stack: React + FastAPI + MongoDB + Nginx
# ============================================================================

version: '3.8'

networks:
  clinomic-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  nginx_certs:
    driver: local
  app_logs:
    driver: local

services:
  # ==========================================================================
  # MongoDB - Production Configuration
  # ==========================================================================
  mongodb:
    image: mongo:7.0
    container_name: clinomic-mongodb
    restart: unless-stopped
    
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: clinomic
    
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      - ./mongo-init:/docker-entrypoint-initdb.d:ro
    
    networks:
      clinomic-network:
        ipv4_address: 172.28.0.10
    
    ports:
      - "127.0.0.1:27017:27017"  # Only localhost access
    
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 512M
    
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # ==========================================================================
  # Backend - FastAPI + ML Models
  # ==========================================================================
  backend:
    image: ghcr.io/dev-abiox/production-ready/backend:latest
    container_name: clinomic-backend
    restart: unless-stopped
    
    environment:
      - APP_ENV=prod
      - MONGO_URL=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017/clinomic?authSource=admin
      - DATABASE_URL=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017/clinomic?authSource=admin
      - DB_NAME=clinomic
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=60
      - REFRESH_TOKEN_EXPIRE_DAYS=30
      - MASTER_ENCRYPTION_KEY=${MASTER_ENCRYPTION_KEY}
      - AUDIT_SIGNING_KEY=${AUDIT_SIGNING_KEY}
      - CORS_ORIGINS=https://clinomiclabs.com,https://www.clinomiclabs.com
      - DEMO_MODE_ENABLED=false
      - RATE_LIMIT_ENABLED=true
      - MFA_REQUIRED_ROLES=ADMIN,DOCTOR
      - LOG_LEVEL=INFO
    
    volumes:
      - app_logs:/app/logs
      - ./backend/b12_clinical_engine_v1.0:/app/b12_clinical_engine_v1.0:ro
    
    networks:
      clinomic-network:
        ipv4_address: 172.28.0.20
    
    ports:
      - "127.0.0.1:8001:8001"  # Only localhost access
    
    depends_on:
      mongodb:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
    
    logging:
      driver: "json-file"
      options:
        max-size: "200m"
        max-file: "10"
    
    labels:
      - "com.clinomic.service=backend"
      - "com.clinomic.version=${GIT_COMMIT:-unknown}"

  # ==========================================================================
  # Frontend - React Application
  # ==========================================================================
  frontend:
    image: ghcr.io/dev-abiox/production-ready/frontend:latest
    container_name: clinomic-frontend
    restart: unless-stopped
    
    environment:
      - NODE_ENV=production
      - REACT_APP_BACKEND_URL=https://clinomiclabs.com
    
    networks:
      clinomic-network:
        ipv4_address: 172.28.0.30
    
    ports:
      - "127.0.0.1:3000:3000"  # Only localhost access
    
    depends_on:
      - backend
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 64M
    
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    
    labels:
      - "com.clinomic.service=frontend"

  # ==========================================================================
  # Nginx - Reverse Proxy & SSL Termination
  # ==========================================================================
  nginx:
    image: nginx:1.25-alpine
    container_name: clinomic-nginx
    restart: unless-stopped
    
    volumes:
      - ./nginx/clinomic.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
      - nginx_certs:/etc/nginx/certs
    
    networks:
      clinomic-network:
        ipv4_address: 172.28.0.5
    
    ports:
      - "80:80"
      - "443:443"
    
    depends_on:
      - frontend
      - backend
    
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
    
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
